---
title: "Team RenderMages"
author: "Team Render Mages"
date: "2023-11-07"
output: github_document
always_allow_html: true

---

### LOADING PACKAGES AND LIBRARIES

```{r error=FALSE,warning =FALSE}

install.packages('tidyverse')
install.packages('dplyr')
install.packages('plyr')
install.packages(c("ggplot2", "plotly"))
install.packages("janitor")
library(zoo)
library(janitor)
library(plyr)
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(plotly)
```

***Import Files***
```{r}

allVisitsTogether<- read_csv("allVisitsByZip.csv")
sviTravis<-read_csv("sviTravis.csv")

```

***Calculate a baseline between the years to make up for the leap year***
```{r}
# baseline 2019
baseline2019<-allVisitsTogether %>%  #Both have 365 days
  filter(Date>=as.Date("2019-01-01"),Date<as.Date("2020-01-01")) %>%
  mutate(DayOfWeek=weekdays(as.Date(Date))) %>% as_tibble()

# visits 2020
visits2020<-allVisitsTogether %>%  as_tibble() %>%#Both have 366 days
  filter(Date>=as.Date("2020-01-01"),Date<as.Date("2021-01-01"))%>%
  mutate(DayOfWeek=weekdays(as.Date(Date))) %>% mutate(Zip=as.character(Zip))`

```
***Create Plot to Visualize Mobility from January 2020 through January 2021***
```{r}

allVisitsTogether %>% select(DateWeek, Zip,contains("Vis")) %>% 
  group_by(DateWeek, Zip) %>% summarise_each(sum) %>% 
  mutate(totalVisits=IntraVisits + InterVisitsOut + InterVisitsIn) %>%
  ggplot(aes(x=DateWeek,y=totalVisits/1000000, group=Zip,color=as.factor(Zip))) +
  theme_bw() + xlab("") + ylab("Total Visits (in millions)") +
  geom_line() + theme(legend.position = "none", text=element_text(size=20)) 
```



***Taking the Date and Dateweek values***
```{r}
daysAndWeeks2020<-visits2020 %>% select(contains("Date")) %>% unique()
```

***baseline 2019 merged with 2020 dates/dateweek/daysofweek***
```{r}
verB<-baseline2019 %>% mutate(Date0=as.Date(Date)+364) %>% ## Ask for help
  mutate(DayOfWeek0=weekdays(as.Date(Date))) %>% 
  mutate(Date1=ifelse(Date0>=as.Date("2020-02-29"),as.Date(Date0)+1,as.Date(Date0)))%>% #Daily Basis
  mutate(Date2=as.Date(Date1,origin="1970-01-01")) %>%
  mutate(DayOfWeek=weekdays(as.Date(Date2))) %>%   
  filter(Date2>=as.Date("2020-01-01"))%>% as_tibble()
```

***2020 data for mobility, HOW WE CALCULATED MOBILITY***
```{r}
dataForMobRatio2020<-verB %>% select(Date=Date2,DayOfWeek,Zip,contains("Visit")) %>%
  set_names("Date","DayOfWeek","Zip","Base2019Intra","Base2019Out","Base2019In") %>% 
  merge(visits2020 %>% select(-DateWeek,-"...1"),by=c("Date","Zip","DayOfWeek"),all.y = T)%>% 
  drop_na() %>% 
  mutate(MobRatio19=(InterVisitsOut+InterVisitsIn+IntraVisits)/(Base2019Out+Base2019In+Base2019Intra)) %>%
  as_tibble()
```
***dataForMobRatio2020***
***Using MobRatio19Both(Intra/Inter Visits), since it contains inter and intra mobility ***
```{r}
mobilityRatioSmoothed<-dataForMobRatio2020 %>% 
  group_by(Date,Zip,DayOfWeek) %>% ungroup() %>%
  select(Date,Zip,MobRatio19) %>%
  filter(Date<=as.Date("2020-10-11")) %>%
  mutate(Ver1=MobRatio19,Ver2=MobRatio19) %>%arrange(Zip,Date) %>%
  mutate(Ver1=ifelse(Ver1>3,NA,Ver1)) %>% mutate(Ver2=ifelse(Ver2>3,NA,Ver2)) %>% # Typically you have to make a test to confirm that the point are outliers
  fill(Ver1,.direction = "up") %>% fill(Ver2,.direction = "down") %>% 
  mutate(MobRatio19Both1=(Ver1+Ver2)/2) %>% #print(n=65)
  arrange(Zip,Date) %>% group_by(Zip)  %>% drop_na() %>%
  mutate(RollAveMR=zoo::rollmean(MobRatio19Both1,k=14,fill=NA))
```


***Work by weeks (Code we should use)***
```{r}

mobilityRatioSmoothedWeeks <- mobilityRatioSmoothed %>% 
  select(Date, Zip, RollAveMR) %>% drop_na() %>%
  left_join(visits2020 %>% select(Date,DateWeek) %>% unique()) %>% 
  ungroup() %>% select(-Date) %>% group_by(DateWeek, Zip) %>%
  summarise_each(mean)
```

***Plot that Visualizes 2020 MobilityRatio (Compare Mobility to 2019 to 2020) ##########FIX UP!***
```{r}
mobilityRatioSmoothedWeeks %>% 
  ggplot(aes(x=as.Date(DateWeek),y=RollAveMR,color=Zip,group=Zip))+
  geom_line() + theme(legend.position = "none")+
  geom_hline(yintercept = 1)
```

***Values needed for Weekly Plots***
***mobilityRatioSmoothedWeeks$DateWeek %>% unique()***
```{r}
testWeek <- mobilityRatioSmoothedWeeks %>% 
  filter(DateWeek==as.Date("2020-04-06"))
# testWeek
```
***A simple linear model from week of 04/06/2020.  ##########  FIX!!! ***
```{r}
non_labled_plot <- mobilityRatioSmoothedWeeks %>% 
  left_join(sviTravis %>% mutate(Zip=as.character(Zip))) %>% 
  filter(DateWeek==as.Date("2020-04-06")) %>%
  ggplot(aes(x=SVI, y=RollAveMR)) + 
  ggtitle("Rolling Average Mobility Ratio vs Social Vulnerability Index") +
  geom_point() +
  geom_smooth(method = "lm")
non_labled_plot
```
***Summary of lm (linear model)***
```{r}
testWeek <- mobilityRatioSmoothedWeeks %>% 
  left_join(sviTravis %>% mutate(Zip=as.character(Zip))) %>% 
  filter(DateWeek==as.Date("2020-04-06"))

# Results
summary(lm(RollAveMR~SVI,data = testWeek))
```

***Looking at the first half of the year 2020 to evaluate relationships betwen Mobility and SVI***
```{r}
Weeks <- mobilityRatioSmoothedWeeks %>% filter(DateWeek<as.Date("2020-07-01")) %>%
  pull(DateWeek) %>% unique()
```
***(gathering data for the first six months)***
***We are obatining the coefficents to evalute if there is a relationship between changes in mobility and the SVI?***
***Is this relationship dependent on mobility restrictions?***

```{r}
w= 1
statMobilityRatio <- NULL
for(w in 1:length(Weeks)){
  testWeek <- mobilityRatioSmoothedWeeks %>% 
    left_join(sviTravis %>% mutate(Zip=as.character(Zip))) %>% 
    filter(DateWeek==as.Date(Weeks[w]))
  Info <- summary(lm(RollAveMR~SVI,data = testWeek))
  name <- data.frame(slope=Info$coefficients[2,1], pvalue=Info$coefficients[2,4],
                     rsquared=Info$r.squared, meanMR=testWeek %>% pull(RollAveMR) %>% mean(),
                     week=Weeks[w])
  statMobilityRatio <- rbind(statMobilityRatio,name) #stack
}
statMobilityRatio

#Look at Slope (The realtionship of svi and mobility from ) ################## FIX!!!
statMobilityRatio %>% ggplot(aes(x=week, y=slope)) +
  geom_line()

#MeanMr                                                   ################## FIX!!!
statMobilityRatio %>% ggplot(aes(x=week, y=meanMR)) +
  geom_line()
```

***Calculate Pvalue***
```{r}       
################# FIX!!!
statMobilityRatio %>% ggplot(aes(x=week, y=pvalue)) +
  geom_line() + 
  geom_hline(yintercept = 0.05, color="red") # month of april there's a relationship 
```

***Investigate differences in SVI scores and hospitals for areas of the city of Austin***
```{r}
df <- clean_names(read.csv('Zip_SVI_Region_Hospital.csv'))

zip_divisions <- df %>%
  select(zip,area_of_austin)

df$area_of_austin <- trimws(df$area_of_austin)

# Use dplyr to calculate the average SVI scores and the total number of hospitals by area
result <- df %>%
  group_by(area_of_austin) %>%
  summarize(avg_SVI = round(mean(svi),2), total_hospitals = sum(hospital),
            max_SVI = round(max(svi),4), min_SVI = round(min(svi),4))

# Create the Plotly bar graph
p <- plot_ly(data = result, x = ~area_of_austin, y = ~avg_SVI, type = "bar",
             hovertext=paste("Total Hospitals:", result$total_hospitals,"<br>","Max SVI:", result$max_SVI, "<br>",
                          "Min SVI:", result$min_SVI),
             marker = list(color = ~avg_SVI, colorscale = "Reds", text = NULL)) %>%
  layout(title = list(text = "Mean SVI Scores by Area of City", 
                      x = 0.5, 
                      xanchor = "center",
                      font = list(family = "Arial", weight = "bold")),
         xaxis = list(title = "Division of Austin City"),
         yaxis = list(title = "Mean SVI Score"),
         hoverlabel = list(bgcolor = "black", font = list(size = 12)))
(p)
```

***Investigate the differences in mobility between 2019 and 2020***
```{r}
alldata = ("all_data.csv")
alldata_2019_2020 <- alldata[alldata$years %in% c(2019, 2020),]
plot=ggplot_object <- ggplot(alldata_2019_2020, aes(x = as.Date(Date), y = MeanVisitsIntra)) +
  geom_line() +
  labs(x = "Date", y = "Mean Visits Intra") +
  facet_wrap(~ years, ncol = 1) +
  ggtitle("Mean Visits Intra in 2019 and 2020")

ggplotly(plot)

```

