library(tidyverse)
library(plyr)

remove(list = ls())

archivosMob<-Sys.glob("visits_by_day_by_zip_*") # Put file path in if needed

IntraMobilityByZipByDayAndWeek<-list()
InterMobilityByZipByDayAndWeekOut<-list()
InterMobilityByZipByDayAndWeekIn<-list()
ExternalMobByZipByDayAndByWeek<-list()

l=2

sviTravis<-read_csv("sviTravis.csv") # Put file path in if needed
zipsTravis<-sviTravis

for (l in 1:length(archivosMob)){
  ver<-read_csv(archivosMob[l]) 
  edgeListAll<-ver %>% gather("origin_zip","number_of_visits",-date,-dest_zip) %>%
    filter(number_of_visits!=0)
  edgeListAll$dest_zip <-as.character(edgeListAll$dest_zip)
  fecha<-as.vector(eval(archivosMob[l]) %>% str_split(.,"_") %>% unlist(.)) 
  fecha<-fecha[6] %>% str_split(.,".c") %>% unlist() 
  #Total intra visits by day/week (IntraMobilityByZipByDayAndWeek)
  #This file contains all data needed to make maps, temporal and else
  intraByDayAndWeekByZip<-edgeListAll %>% filter(origin_zip==dest_zip) %>% 
    subset(dest_zip %in% zipsTravis$Zip) %>% #Only those in the file counties
    select(-dest_zip) %>% #select(date,origin_zip) %>% unique() %>% group_by(date) %>% dplyr::count()
    group_by(date,origin_zip) %>% 
    summarise_each(funs(sum)) %>% #select(-origin_zip) %>% group_by(date) %>% summarise_each(funs(sum))
    merge(edgeListAll %>% filter(origin_zip==dest_zip) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
            select(-dest_zip) %>% select(date,origin_zip) %>% unique() %>% 
            group_by(date) %>% dplyr::count(),
          by="date") %>%
    merge(edgeListAll %>% filter(origin_zip==dest_zip) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
            select(-dest_zip) %>% select(date,origin_zip) %>% unique() %>% 
            select(origin_zip) %>%group_by(origin_zip) %>% dplyr::count(),by="origin_zip") %>%
    set_names(.,"Zip","Date","TotalVisitsIntra","ActiveZipsIntraInDay","TimesZipActiveInWeek") %>%
    mutate(DateWeek=fecha[[1]]) %>% #creating a new variable called dateweek with the first element of the vec that contains the date
    merge(zipsTravis,by="Zip") %>% arrange(Date)
  IntraMobilityByZipByDayAndWeek[[l]]<-intraByDayAndWeekByZip
  names(IntraMobilityByZipByDayAndWeek)[[l]]<-fecha[[1]]
  #Inter visits by weeks (InterMobilityByZipByDayAndWeekOut) 
  #with this we can calculate files for maps and temporal
  #Out
  interByDayByWeekByZipOut<-edgeListAll %>% filter(origin_zip!=dest_zip) %>% 
    subset(dest_zip %in% zipsTravis$Zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
    select(-dest_zip) %>%
    group_by(date,origin_zip) %>% 
    summarise_each(funs(sum,n())) %>% #ungroup() %>%select(-date) %>% group_by(origin_zip) %>% summarise_each(funs(sum,n()))
    merge(edgeListAll %>% filter(origin_zip!=dest_zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
            select(-date,-number_of_visits) %>% unique() %>% 
            select(origin_zip) %>% group_by(origin_zip)%>% dplyr::count(origin_zip),
          by="origin_zip") %>% mutate(DateWeek=fecha[1]) %>% arrange(origin_zip,date) %>%
    set_names("Zip","Date","TotalVisitsInterOut","ZipVisInDayInterOut","ZipVisInWeekInterOut","DateWeek") %>%
    merge(zipsTravis,by="Zip")
  InterMobilityByZipByDayAndWeekOut[[l]]<-interByDayByWeekByZipOut
  names(InterMobilityByZipByDayAndWeekOut)[[l]]<-fecha[[1]]
  #In
  interByDayByWeekByZipIn<-edgeListAll %>% filter(origin_zip!=dest_zip) %>% 
    subset(dest_zip %in% zipsTravis$Zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
    select(-origin_zip) %>%
    group_by(date,dest_zip) %>% 
    summarise_each(funs(sum,n())) %>%
    merge(edgeListAll %>% filter(origin_zip!=dest_zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
            select(-date,-number_of_visits) %>% unique() %>% 
            select(dest_zip) %>% group_by(dest_zip) %>% dplyr::count(),
          by="dest_zip") %>% mutate(DateWeek=fecha[1]) %>% arrange(dest_zip,date) %>%
    set_names("Zip","Date","TotalVisitsToInterIn","ToZipVisInDayInterIn","ToZipVisInWeekInterIn","DateWeek")%>%
    merge(zipsTravis,by="Zip")
  InterMobilityByZipByDayAndWeekIn[[l]]<-interByDayByWeekByZipIn 
  names(InterMobilityByZipByDayAndWeekIn)[[l]]<-fecha[[1]]
  #External visits by weeks (IntraMobilityByWeek) and temporal (TemporalIntraMob)
  externalByDateByZip<-edgeListAll %>% filter(origin_zip=="99999") %>% 
    select(-origin_zip) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
    group_by(date,dest_zip) %>% 
    summarise_each(funs(sum)) %>%
    merge(edgeListAll %>% filter(origin_zip=="99999") %>% 
            select(-number_of_visits) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
            group_by(date) %>% arrange(date) %>% unique() %>% 
            dplyr::count(),by="date") %>%
    set_names("Date","Zip","TotalVisitsMadeExt","ZipsVisitedExt") %>%
    mutate(DateWeek=fecha[[1]],ZipExtVisInWeek=77)%>%
    merge(zipsTravis,by="Zip")
  ExternalMobByZipByDayAndByWeek[[l]]<-externalByDateByZip
  names(ExternalMobByZipByDayAndByWeek)[[l]]<-fecha[[1]]
  #De aqui saque el numero de zips diferentes visitados en la semana
  #edgeListAll %>% filter(origin_zip=="99999",date==as.Date("2018/01/03 ")) %>% 
  #  select(dest_zip) %>% subset(dest_zip %in% counties$Zip) %>%
  #  unique() %>% 
  #  dplyr::count()
}

# view(intraByDayAndWeekByZip)

# Removed Travis from IntraMobilityByZipByDayAndWeek* and the following 3 
totalVisitsIntraByZip<-ldply(IntraMobilityByZipByDayAndWeek,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsIntra) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="Intra") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source") 

totalVisitsInterOutByZip<-ldply(InterMobilityByZipByDayAndWeekOut,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsInterOut) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="InterOut") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source")

totalVisitsInterInByZip<-ldply(InterMobilityByZipByDayAndWeekIn,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsToInterIn) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="InterIn") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source")

totalVisitsExtByZip<-ldply(ExternalMobByZipByDayAndByWeekTravis,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsMadeExt) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="External") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source")


# Merged Intra, InterOut, InterIn vales wiht Date/Dateweek
allVisitsTogether<-totalVisitsIntraByZip %>% select(-Source,-MeanVisits) %>%
  set_names("Date","DateWeek","Zip","IntraVisits") %>%
  merge(totalVisitsInterOutByZip %>% 
          select(Date,DateWeek,Zip,"InterVisitsOut"=TotalVisits),
        by=c("Date","DateWeek","Zip"),all = T) %>%
  merge(totalVisitsInterInByZip %>% 
          select(Date,DateWeek,Zip,"InterVisitsIn"=TotalVisits),
        by=c("Date","DateWeek","Zip"),all=T) %>%
  replace_na(list(IntraVisits = 0, InterVisitsOut = 0,InterVisitsIn=0))
# view(allVisitsTogether)

baseline2019<-allVisitsTogether %>%  #Both have 365 days
  filter(Date>=as.Date("2019-01-01"),Date<as.Date("2020-01-01")) %>%
  mutate(DiaSemana=weekdays(as.Date(Date))) %>% as_tibble()

# view(baseline2019)
##################################################

visits2020<-allVisitsTogether %>%  as_tibble() %>%#Both have 366 days
  filter(Date>=as.Date("2020-01-01"),Date<as.Date("2021-01-01"))%>%
  mutate(DiaSemana=weekdays(as.Date(Date)))

##################################################

daysAndWeeks2020<-visits2020 %>% select(contains("Date")) %>% unique()


verB<-baseline2019 %>% mutate(Date0=as.Date(Date)+364) %>% ## Ask for help
  mutate(DiaSemana0=weekdays(as.Date(Date))) %>% 
  mutate(Date1=ifelse(Date0>=as.Date("2020-02-29"),as.Date(Date0)+1,as.Date(Date0)))%>% #Daily Basis
  mutate(Date2=as.Date(Date1,origin="1970-01-01")) %>%
  mutate(DiaSemana=weekdays(as.Date(Date2))) %>%   
  filter(Date2>=as.Date("2020-01-01"))%>% as_tibble()

################################################## 
visits2020 %>% select(-DateWeek) %>% filter(Date>=as.Date("2020-01-06"))

dataForMobRatio2020<-verB %>% select(Date=Date2,DiaSemana,Zip,contains("Visit")) %>%
  set_names("Date","DiaSemana","Zip","Base2019Intra","Base2019Out","Base2019In") %>% 
  merge(visits2020 %>% select(-DateWeek),by=c("Date","Zip","DiaSemana"),all.y = T)%>% #Include every single y value in verB (Date)
  drop_na() %>% #
  #  mutate(MobRatio19Intra=(IntraVisits)/(Base2019Intra)) %>%
  #  mutate(MobRatio19=(InterVisitsOut+InterVisitsIn)/(Base2019Out+Base2019In)) %>%
  mutate(MobRatio19=(InterVisitsOut+InterVisitsIn+IntraVisits)/(Base2019Out+Base2019In+Base2019Intra)) %>%
  #  mutate(PercChange19Intra=100*((Base2019Intra)-(IntraVisits))/(Base2019Intra)) %>%
  #  mutate(PercChange19=100*((Base2019Out+Base2019In)-(InterVisitsOut+InterVisitsIn))/(Base2019Out+Base2019In)) %>%
  #  mutate(PercChange19Both=100*((Base2019Out+Base2019In+Base2019Intra)-(InterVisitsOut+InterVisitsIn+IntraVisits))/(Base2019Out+Base2019In+Base2019Intra)) %>%
  as_tibble() 

view(dataForMobRatio2020)

library(zoo)

# I am using MobRatio19Both, since it contains inter and intra mobility
mobilityRatioSmoothed<-dataForMobRatio2020 %>% 
  group_by(Date,Zip,DiaSemana) %>% ungroup() %>%
  select(Date,Zip,MobRatio19) %>%
  filter(Date<=as.Date("2020-10-11")) %>%
  mutate(Ver1=MobRatio19,Ver2=MobRatio19) %>%arrange(Zip,Date) %>%
  mutate(Ver1=ifelse(Ver1>3,NA,Ver1)) %>% mutate(Ver2=ifelse(Ver2>3,NA,Ver2)) %>% # Typically you have to make a test to confirm that the point are outliers
  fill(Ver1,.direction = "up") %>% fill(Ver2,.direction = "down") %>% 
  mutate(MobRatio19Both1=(Ver1+Ver2)/2) %>% #print(n=65)
  arrange(Zip,Date) %>% group_by(Zip)  %>% drop_na() %>%
  mutate(RollAveMR=zoo::rollmean(MobRatio19Both1,k=14,fill=NA)) 

view(mobilityRatioSmoothed)

mobilityRatioSmoothed %>% #print(n=65)
  ggplot(aes(x=Date,y=RollAveMR,color=Zip,group=Zip))+
  geom_line() + theme(legend.position = "none")+
  geom_hline(yintercept = 1)

mobilityRatioSmoothed %>% 
  left_join(sviTravis %>% mutate(Zip=as.character(Zip))) %>% 
  filter(Date==as.Date("2020-04-05")) %>%
  ggplot(aes(x=SVI, y=RollAveMR)) + 
  geom_point() +
  geom_smooth(method = "lm") # Linear Regression implemented for plot


test <- mobilityRatioSmoothed %>% 
  left_join(sviTravis %>% mutate(Zip=as.character(Zip))) %>% 
  filter(Date==as.Date("2020-04-05"))


summary(lm(RollAveMR~SVI,data = test)) #summary of Linear Rgression
# Will optimize later




# Work by weeks Code
mobilityRatioSmoothedWeeks <- mobilityRatioSmoothed %>% 
  select(Date, Zip, RollAveMR) %>% drop_na() %>%
  left_join(visits2020 %>% select(Date,DateWeek) %>% unique()) %>% 
  ungroup() %>% select(-Date) %>% group_by(DateWeek, Zip) %>%
  summarise_each(mean)

mobilityRatioSmoothedWeeks %>%
  ggplot(aes(x=as.Date(DateWeek),y=RollAveMR,color=Zip,group=Zip))+
  geom_line() + theme(legend.position = "none")+
  geom_hline(yintercept = 1)

mobilityRatioSmoothedWeeks$DateWeek %>% unique()

testWeek <- mobilityRatioSmoothedWeeks %>% 
  filter(DateWeek==as.Date("2020-04-13"))

mobilityRatioSmoothedWeeks %>% 
  left_join(sviTravis %>% mutate(Zip=as.character(Zip))) %>% 
  filter(DateWeek==as.Date("2020-04-13")) %>%
  ggplot(aes(x=SVI, y=RollAveMR)) + 
  geom_point() +
  geom_smooth(method = "lm")


testWeek <- mobilityRatioSmoothedWeeks %>% 
  left_join(sviTravis %>% mutate(Zip=as.character(Zip))) %>% 
  filter(DateWeek==as.Date("2020-04-13"))

summary(lm(RollAveMR~SVI,data = testWeek))