library(tidyverse)

remove(list = ls())

archivosMob<-Sys.glob("ZIP_TO_ZIP_MOBILITY/visits_by_day_by_zip_*")

IntraMobilityByZipByDayAndWeek<-list()
InterMobilityByZipByDayAndWeekOut<-list()
InterMobilityByZipByDayAndWeekIn<-list()
ExternalMobByZipByDayAndByWeek<-list()

l=2

sviTravis<-read_csv("~/Projects/HPC-2023/sviTravis.csv")
zipsTravis<-sviTravis

for (l in 1:length(archivosMob)){
  ver<-read_csv(archivosMob[l]) 
  edgeListAll<-ver %>% gather("origin_zip","number_of_visits",-date,-dest_zip) %>%
    filter(number_of_visits!=0)
  edgeListAll$dest_zip <-as.character(edgeListAll$dest_zip)
  fecha<-as.vector(eval(archivosMob[l]) %>% str_split(.,"_") %>% unlist(.))
  fecha<-fecha[9] %>% str_split(.,".c") %>% unlist()
  #Total intra visits by day/week (IntraMobilityByZipByDayAndWeek)
  #This file contains all data needed to make maps, temporal and else
  intraByDayAndWeekByZip<-edgeListAll %>% filter(origin_zip==dest_zip) %>% 
    subset(dest_zip %in% zipsTravis$Zip) %>% #Only those in the file counties
    select(-dest_zip) %>% #select(date,origin_zip) %>% unique() %>% group_by(date) %>% dplyr::count()
    group_by(date,origin_zip) %>% 
    summarise_each(funs(sum)) %>% #select(-origin_zip) %>% group_by(date) %>% summarise_each(funs(sum))
    merge(edgeListAll %>% filter(origin_zip==dest_zip) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
            select(-dest_zip) %>% select(date,origin_zip) %>% unique() %>% 
            group_by(date) %>% dplyr::count(),
          by="date") %>%
    merge(edgeListAll %>% filter(origin_zip==dest_zip) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
            select(-dest_zip) %>% select(date,origin_zip) %>% unique() %>% 
            select(origin_zip) %>%group_by(origin_zip) %>% dplyr::count(),by="origin_zip") %>%
    set_names("Zip","Date","TotalVisitsIntra","ActiveZipsIntraInDay","TimesZipActiveInWeek") %>%
    mutate(DateWeek=fecha[[1]]) %>%
    merge(zipsTravis,by="Zip") %>% arrange(Date)
  IntraMobilityByZipByDayAndWeek[[l]]<-intraByDayAndWeekByZip
  names(IntraMobilityByZipByDayAndWeek)[[l]]<-fecha[[1]]
  #Inter visits by weeks (InterMobilityByZipByDayAndWeekOut) 
  #with this we can calculate files for maps and temporal
  #Out
  interByDayByWeekByZipOut<-edgeListAll %>% filter(origin_zip!=dest_zip) %>% 
    subset(dest_zip %in% zipsTravis$Zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
    select(-dest_zip) %>%
    group_by(date,origin_zip) %>% 
    summarise_each(funs(sum,n())) %>% #ungroup() %>%select(-date) %>% group_by(origin_zip) %>% summarise_each(funs(sum,n()))
    merge(edgeListAll %>% filter(origin_zip!=dest_zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
            select(-date,-number_of_visits) %>% unique() %>% 
            select(origin_zip) %>% group_by(origin_zip)%>% dplyr::count(origin_zip),
          by="origin_zip") %>% mutate(DateWeek=fecha[1]) %>% arrange(origin_zip,date) %>%
    set_names("Zip","Date","TotalVisitsInterOut","ZipVisInDayInterOut","ZipVisInWeekInterOut","DateWeek") %>%
    merge(zipsTravis,by="Zip")
  InterMobilityByZipByDayAndWeekOut[[l]]<-interByDayByWeekByZipOut
  names(InterMobilityByZipByDayAndWeekOut)[[l]]<-fecha[[1]]
  #In
  interByDayByWeekByZipIn<-edgeListAll %>% filter(origin_zip!=dest_zip) %>% 
    subset(dest_zip %in% zipsTravis$Zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
    select(-origin_zip) %>%
    group_by(date,dest_zip) %>% 
    summarise_each(funs(sum,n())) %>%
    merge(edgeListAll %>% filter(origin_zip!=dest_zip) %>% subset(origin_zip %in% zipsTravis$Zip) %>%
            select(-date,-number_of_visits) %>% unique() %>% 
            select(dest_zip) %>% group_by(dest_zip) %>% dplyr::count(),
          by="dest_zip") %>% mutate(DateWeek=fecha[1]) %>% arrange(dest_zip,date) %>%
    set_names("Zip","Date","TotalVisitsToInterIn","ToZipVisInDayInterIn","ToZipVisInWeekInterIn","DateWeek")%>%
    merge(zipsTravis,by="Zip")
  InterMobilityByZipByDayAndWeekIn[[l]]<-interByDayByWeekByZipIn 
  names(InterMobilityByZipByDayAndWeekIn)[[l]]<-fecha[[1]]
  #External visits by weeks (IntraMobilityByWeek) and temporal (TemporalIntraMob)
  externalByDateByZip<-edgeListAll %>% filter(origin_zip=="99999") %>% 
    select(-origin_zip) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
    group_by(date,dest_zip) %>% 
    summarise_each(funs(sum)) %>%
    merge(edgeListAll %>% filter(origin_zip=="99999") %>% 
            select(-number_of_visits) %>% subset(dest_zip %in% zipsTravis$Zip) %>%
            group_by(date) %>% arrange(date) %>% unique() %>% 
            dplyr::count(),by="date") %>%
    set_names("Date","Zip","TotalVisitsMadeExt","ZipsVisitedExt") %>%
    mutate(DateWeek=fecha[[1]],ZipExtVisInWeek=77)%>%
    merge(zipsTravis,by="Zip")
  ExternalMobByZipByDayAndByWeek[[l]]<-externalByDateByZip
  names(ExternalMobByZipByDayAndByWeek)[[l]]<-fecha[[1]]
  #De aqui saque el numero de zips diferentes visitados en la semana
  #edgeListAll %>% filter(origin_zip=="99999",date==as.Date("2018/01/03 ")) %>% 
  #  select(dest_zip) %>% subset(dest_zip %in% counties$Zip) %>%
  #  unique() %>% 
  #  dplyr::count()
}

totalVisitsIntraByZip<-ldply(IntraMobilityByZipByDayAndWeekTravis,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsIntra) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="Intra") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source") 
totalVisitsInterOutByZip<-ldply(InterMobilityByZipByDayAndWeekOutTravis,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsInterOut) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="InterOut") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source")
totalVisitsInterInByZip<-ldply(InterMobilityByZipByDayAndWeekInTravis,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsToInterIn) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="InterIn") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source")
totalVisitsExtByZip<-ldply(ExternalMobByZipByDayAndByWeekTravis,rbind) %>% select(-.id) %>%
  select(Date,DateWeek,Zip,TotalVisitsMadeExt) %>% group_by(Date,DateWeek,Zip) %>%
  summarise_each(list(sum,mean)) %>% mutate(Source="External") %>%
  set_names("Date","DateWeek","Zip","TotalVisits","MeanVisits","Source")
